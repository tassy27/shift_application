<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ログイン | Shift Aggregation</title>
  <link rel="stylesheet" href="/css/app.css" />
</head>
<body>
  <div class="wrap">
    <header class="page-header">
      <h1>シフト集約システム <span class="pill">Login</span></h1>
      <p class="subtext">社員名を選択し、メールアドレスを入力してログインします。</p>
    </header>

    <section class="card">
      <h2>社員ログイン</h2>
      <div class="row">
        <div><label>社員名</label><select id="employeeSelect"></select></div>
        <div><label>メールアドレス</label><input id="emailInput" type="email" placeholder="name@example.com" /></div>
      </div>
      <button id="employeeLoginBtn" type="button">ログイン</button>
    </section>

    <section class="card">
      <h2>セッション</h2>
      <p id="statusText">未ログイン</p>
      <div class="btn-row-3">
        <button id="goEmployeeBtn" type="button" style="display:none;">シフト申請画面へ</button>
        <button id="goAdminBtn" type="button" style="display:none;">管理者画面へ</button>
        <button id="logoutBtn" type="button" style="display:none;">ログアウト</button>
      </div>
    </section>

    <section class="card">
      <h2>レスポンス</h2>
      <pre id="out">ready</pre>
    </section>
  </div>

  <script src="/js/app-common.js"></script>
  <script>
    const out = document.getElementById("out");
    const statusText = document.getElementById("statusText");
    const employeeSelect = document.getElementById("employeeSelect");
    const emailInput = document.getElementById("emailInput");
    const goEmployeeBtn = document.getElementById("goEmployeeBtn");
    const goAdminBtn = document.getElementById("goAdminBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    function show(label, data) {
      out.textContent = `[${label}]\\n` + JSON.stringify(data, null, 2);
    }

    async function loadEmployees() {
      try {
        const res = await req("/api/v1/public/employees/active");
        employeeSelect.innerHTML = res.data
          .map((e) => `<option value="${e.id}">${e.displayName} (${e.employeeCode})</option>`)
          .join("");
      } catch (e) {
        show("employee-load-error", e);
      }
    }

    async function renderSession() {
      const me = await getMeOrNull();
      if (!me) {
        statusText.textContent = "未ログイン";
        goEmployeeBtn.style.display = "none";
        goAdminBtn.style.display = "none";
        logoutBtn.style.display = "none";
        return;
      }
      statusText.textContent = `${me.name || me.email} でログイン済み (${me.role})`;
      goEmployeeBtn.style.display = "block";
      goAdminBtn.style.display = me.role === "admin" ? "block" : "none";
      logoutBtn.style.display = "block";
    }

    document.getElementById("employeeLoginBtn").addEventListener("click", async () => {
      const payload = {
        employeeId: Number(employeeSelect.value),
        email: emailInput.value.trim()
      };
      try {
        const res = await req("/api/v1/auth/employee-login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        show("login-success", res);
        await renderSession();
      } catch (e) {
        show("login-error", e);
      }
    });

    goEmployeeBtn.addEventListener("click", () => {
      location.href = "/employee.html";
    });
    goAdminBtn.addEventListener("click", () => {
      location.href = "/admin.html";
    });
    logoutBtn.addEventListener("click", async () => {
      try {
        await req("/api/v1/auth/logout", { method: "POST" });
      } catch (_) {}
      await renderSession();
    });

    loadEmployees().then(renderSession);
  </script>
</body>
</html>
